---
import Layout from "@/layouts/Layout.astro";
import { publications } from "@/data/cv";
import { highlightAuthor } from "@/lib/utils";
import { template } from "@/settings";

// Group publications by year (descending)
const grouped = publications.reduce((acc, paper) => {
  const year = paper.time;
  if (!acc[year]) acc[year] = [];
  acc[year].push(paper);
  return acc;
}, {} as Record<string, typeof publications>);

const years = Object.keys(grouped).sort((a, b) => Number(b) - Number(a));
const totalPapers = publications.length;
---

<Layout title="Papers">
  <div class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-3xl font-bold">Publications</h1>
      <p class="text-base-content/60 mt-1">
        {totalPapers} papers &middot; {years[years.length - 1]}&ndash;{years[0]}
      </p>
    </div>

    <!-- Controls -->
    <div class="flex justify-end gap-2 mb-4">
      <button id="expand-all" class="btn btn-xs btn-outline btn-secondary">Expand All</button>
      <button id="collapse-all" class="btn btn-xs btn-outline btn-secondary">Collapse All</button>
    </div>

    <!-- Year Sections -->
    <div class="space-y-2">
      {years.map((year) => (
        <div class="year-group" data-year={year}>
          <!-- Year Header (clickable) -->
          <button
            class="year-toggle w-full flex items-center gap-3 py-3 cursor-pointer select-none group"
            aria-expanded="true"
            aria-controls={`papers-${year}`}
          >
            <span class="text-2xl font-bold">{year}</span>
            <span class="badge badge-sm badge-secondary">{grouped[year].length}</span>
            <span class="flex-1 h-px bg-base-300"></span>
            <svg
              class="chevron-icon w-5 h-5 text-base-content/50 transition-transform duration-300 group-hover:text-base-content"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </button>

          <!-- Papers List -->
          <div id={`papers-${year}`} class="papers-container overflow-hidden transition-all duration-300">
            <div class="space-y-3 pb-4">
              {grouped[year].map((paper) => (
                <div class="card bg-base-200 shadow-sm hover:shadow-md transition-shadow duration-200">
                  <div class="card-body p-5">
                    <!-- Title -->
                    <h2 class="card-title text-base leading-snug">
                      <a
                        href={paper.link}
                        class="hover:text-accent transition-colors duration-200"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        {paper.title}
                      </a>
                    </h2>

                    <!-- Authors -->
                    <p class="text-sm text-base-content/70 mt-1">
                      <span set:html={highlightAuthor(paper.authors)} />
                    </p>

                    <!-- Journal + Link row -->
                    <div class="flex items-center justify-between flex-wrap gap-2 mt-2">
                      <span class="text-sm italic text-base-content/60">{paper.journal}</span>
                      <a
                        href={paper.link}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="btn btn-xs btn-outline btn-accent gap-1"
                      >
                        DOI
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M7 17L17 7" /><path d="M7 7h10v10" />
                        </svg>
                      </a>
                    </div>

                    <!-- Abstract Toggle -->
                    {paper.abstract && (
                      <div class="mt-2">
                        <button class="abstract-toggle text-xs font-medium text-base-content/50 hover:text-accent transition-colors cursor-pointer">
                          ▸ Abstract
                        </button>
                        <div class="abstract-text hidden mt-2 text-sm text-base-content/70 leading-relaxed p-3 bg-base-300/40 rounded-lg border-l-3 border-accent/30">
                          {paper.abstract}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    // Year section collapse/expand
    const yearToggles = document.querySelectorAll<HTMLButtonElement>(".year-toggle");

    yearToggles.forEach((toggle) => {
      const container = toggle.nextElementSibling as HTMLElement;
      if (!container) return;

      // Set initial max-height for smooth animation
      container.style.maxHeight = container.scrollHeight + "px";

      toggle.addEventListener("click", () => {
        const expanded = toggle.getAttribute("aria-expanded") === "true";
        toggle.setAttribute("aria-expanded", String(!expanded));

        const chevron = toggle.querySelector(".chevron-icon") as HTMLElement;

        if (expanded) {
          // Collapse
          container.style.maxHeight = "0px";
          container.style.opacity = "0";
          if (chevron) chevron.style.transform = "rotate(-90deg)";
        } else {
          // Expand
          container.style.maxHeight = container.scrollHeight + "px";
          container.style.opacity = "1";
          if (chevron) chevron.style.transform = "rotate(0deg)";
        }
      });
    });

    // Expand All
    document.getElementById("expand-all")?.addEventListener("click", () => {
      yearToggles.forEach((toggle) => {
        toggle.setAttribute("aria-expanded", "true");
        const container = toggle.nextElementSibling as HTMLElement;
        const chevron = toggle.querySelector(".chevron-icon") as HTMLElement;
        if (container) {
          container.style.maxHeight = container.scrollHeight + "px";
          container.style.opacity = "1";
        }
        if (chevron) chevron.style.transform = "rotate(0deg)";
      });
    });

    // Collapse All
    document.getElementById("collapse-all")?.addEventListener("click", () => {
      yearToggles.forEach((toggle) => {
        toggle.setAttribute("aria-expanded", "false");
        const container = toggle.nextElementSibling as HTMLElement;
        const chevron = toggle.querySelector(".chevron-icon") as HTMLElement;
        if (container) {
          container.style.maxHeight = "0px";
          container.style.opacity = "0";
        }
        if (chevron) chevron.style.transform = "rotate(-90deg)";
      });
    });

    // Abstract toggles
    document.querySelectorAll<HTMLButtonElement>(".abstract-toggle").forEach((btn) => {
      btn.addEventListener("click", () => {
        const abstractText = btn.nextElementSibling as HTMLElement;
        if (!abstractText) return;

        const isHidden = abstractText.classList.contains("hidden");
        abstractText.classList.toggle("hidden");
        btn.textContent = isHidden ? "▾ Abstract" : "▸ Abstract";
      });
    });
  });
</script>

<style>
  .papers-container {
    transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.25s ease;
  }
</style>
